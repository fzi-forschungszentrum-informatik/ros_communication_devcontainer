---
parameters:
  dir_path: # will be set automatically by create_session.py
  before_command: # e.g. "echo test"

  rec: false
  rec_command_1: "ros2 bag record -o ${dir_path}/rec_sync_ --regex '(.*)_sync$' --max-bag-size 5120"
  rec_command_2:
  rec_command_3:
  rec_command_4:

  # General OTA parameters
  host_ip: # e.g. "machine_a ip"
  host_name: "" # e.g. "control_center"
  peers: # e.g. "machine_b ip + machine_c ip"
  qos_config_file: '""' # e.g. "/config/qos_config.yaml"

  in: false
  topic_list_paths_incoming: "" # e.g. "/machine_a,/machine_b"
  source_names: "" # e.g. "control_center"
  explicitly_adressed_incoming: false
  locally_used_source_name_incoming: false

  out: false
  topic_list_paths_outgoing: "" # e.g. "/machine_a,/machine_b"
  target_names: "" # e.g. "shuttle_ella,shuttle_anna"
  locally_used_source_name_outgoing: false

  # RMW specific OTA parameters
  zen: false # to use zenoh for OTA communication instaed of CycloneDDS
  zen_mode: # e.g. router, peer or client
  zen_endpoint_role: # e.g. listen or connect
  zen_transport: # e.g. tcp or udp
  zen_main_ip: # ip address of zenoh main endpoint (usually listening router)
  zen_main_port: # e.g. 7447
  zen_pub_allow: # e.g. /ota/machine_a/.*
  zen_sub_allow: # e.g. /ota/machine_b/.*
  zen_qos_pub:
  zen_config_file: ${dir_path}/zenoh.json5
  zen_config_override:

  # Utility
  topic_monitor: false

  network_monitor: true

  heartbeat: false
  heartbeat_topics:
  heartbeat_delay_topic_1:
  heartbeat_delay_topic_2:

common:
  before_commands:
    - if [ '${before_command}' != "None" ]; then ${before_command}; fi

windows:
  - name: REC
    if: rec
    layout: even-vertical
    splits:
      - commands:
        - if [ "${rec_command_1}" == "None" ]; then exit; fi
        - "${rec_command_1}"
      - commands:
        - if [ "${rec_command_2}" == "None" ]; then exit; fi
        - "${rec_command_2}"
      - commands:
        - if [ "${rec_command_3}" == "None" ]; then exit; fi
        - "${rec_command_3}"
      - commands:
        - if [ "${rec_command_4}" == "None" ]; then exit; fi
        - "${rec_command_4}"
    delay: 1
  - name: ZEN
    if: zen
    splits:
      - commands:
        - export RUST_LOG=zenoh=debug,zenoh_bridge_ros2dds=debug
        - if [ '${zen_config_override}' != "None" ]; then export ZENOH_CONFIG_OVERRIDE='${zen_config_override}'; fi
        - /ws/ota_configs/create_zenoh_json5.py -m ${zen_mode} -e ${zen_endpoint_role} -t ${zen_transport} -i ${zen_main_ip} -r ${zen_main_port} -p ${zen_pub_allow} -s ${zen_sub_allow} -q '${zen_qos_pub}' -f ${zen_config_file}
        - zenohd -c ${zen_config_file}
      # Debugging commands:
      #   - zenohd -c ${zen_config_file} --rest-http-port 8000 2>&1 | tee ${zen_config_file}.log
      # - commands:
      #   - sleep 45
      #   - curl http://localhost:8000/@/local/ros2/route/** 2>&1 | tee ${zen_config_file}.route-log
  - name: IN
    if: in
    splits:
      - commands:
        - case ${zen} in [Ff]alse) export RMW_IMPLEMENTATION=rmw_cyclonedds_cpp;; esac
        - case ${zen} in [Ff]alse) export CYCLONEDDS_URI=$(/ws/ota_configs/get_cyclonedds_xml.py -i "${host_ip}" -p "${peers}");; esac
        - case ${zen} in [Ff]alse) export ROS_STATIC_PEERS=$(/ws/session/content/get_data_dict_entries.py -k "${peers}");; esac
        - ros2 run com_py bridge_in --ros-args
            -p base_topic_files:=[${topic_list_paths_incoming}]
            -p host_name:=${host_name}
            -p qos_config_file:='${qos_config_file}'
            -p source_names:=[${source_names}]
            -p explicitly_adressed:=${explicitly_adressed_incoming}
      - commands:
        - ros2 run com_py relay_in --ros-args
            -p base_topic_files:=[${topic_list_paths_incoming}]
            -p host_name:=${host_name}
            -p qos_config_file:='${qos_config_file}'
            -p source_names:=[${source_names}]
            -p explicitly_adressed:=${explicitly_adressed_incoming}
            -p locally_used_source_name:=${locally_used_source_name_incoming}
  - name: OUT
    if: out
    splits:
      - commands:
        - case ${zen} in [Ff]alse) export RMW_IMPLEMENTATION=rmw_cyclonedds_cpp;; esac
        - case ${zen} in [Ff]alse) export CYCLONEDDS_URI=$(/ws/ota_configs/get_cyclonedds_xml.py -i "${host_ip}" -p "${peers}");; esac
        - case ${zen} in [Ff]alse) export ROS_STATIC_PEERS=$(/ws/session/content/get_data_dict_entries.py -k "${peers}");; esac
        - ros2 run com_py bridge_out --ros-args
            -p base_topic_files:=[${topic_list_paths_outgoing}]
            -p host_name:=${host_name}
            -p qos_config_file:='${qos_config_file}'
            -p target_names:=[${target_names}]
      - commands:
        - ros2 run com_py relay_out --ros-args
            -p base_topic_files:=[${topic_list_paths_outgoing}]
            -p host_name:=${host_name}
            -p qos_config_file:='${qos_config_file}'
            -p target_names:=[${target_names}]
            -p locally_used_source_name:=${locally_used_source_name_outgoing}
  - name: TOP
    if: topic_monitor
    splits:
      - commands:
        - ros2 run com_py topic_monitor
  - name: NET
    if: network_monitor
    splits:
      - commands:
        - ip=$(/ws/session/content/get_data_dict_entries.py -k "${host_ip}")
        - interface=$(ip -o addr | awk '/'${ip//./\\.}'\/[0-9]+/ {print $2; exit}')
        - sudo iftop -i "$interface" -f "host $ip"
  - name: BEAT
    if: heartbeat
    splits:
      - commands:
        - ros2 run com_py heartbeat --ros-args -p topic_names:=[${heartbeat_topics}]
      - commands:
        - if [ "${heartbeat_delay_topic_1}" == "None" ]; then exit; fi
        - ros2 topic delay ${heartbeat_delay_topic_1}
      - commands:
        - if [ "${heartbeat_delay_topic_2}" == "None" ]; then exit; fi
        - ros2 topic delay ${heartbeat_delay_topic_2}