input_parameters:
  center_ip_key:
    type: str
    description: Center peer IP key (e.g. machine_a_ip)
  vehicle_ip_key:
    type: str
    description: Vehicle peer IP key (e.g. machine_b_ip)
  vehicle_name:
    type: str
    description: Vehicle peer name (e.g. shuttle_ella)
  vehicle_bag_playback:
    type: bool
    default: false
    description: If true, restamp selected topics to make bag playback appear current

peers: # (for now always exactly 2. This enables semantic naming of peers rather than generic A/B. Also enalbes to not hardcode peer-names, but choose an extraction layer (e.g. vehicle) instead of shuttle_ella/shuttle_anna, which might use the same session config). For each peer also the ip has to be specified.
  center:
    ip_key: ${center_ip_key}
  vehicle:
    ip_key: ${vehicle_ip_key}
    com-name: ${vehicle_name} # the peer com-name property is generally used if the actual name of the peer is a dynamic, e.g. because its a input parameter. So then we differentiate between the session-config-name (here: the generic "vehicle") and the actual name of the peer (here: shuttle_ella). the com-name is the name that is written in plugin.yaml. If no com-name is defined then the session-config-name is used, like for center above.
# this peer data is used to set the ip_local, local_name, ip_remote, remote_name in the plugin.yaml-files.

shared:
  use_topic_monitor: true
  use_heartbeat: true
  # use_in: true and use_out: true do not need be set - they are automatically always should be be set to true in the plugin.yaml

  processing_suffixes:
    restamped: /restamped
    framebridge_global: /globalframe

  compression: # (creates the compression.yaml and decompression.yaml with regexes that exactly match a topic (with ^ and $). the topics should be automatically extracted from the topics below. Also it should be automatically detected that vehicle only compresses and therefore only needs the compressor and the center only needs a decompressor.
    algorithm: bz2
    remove_algorithm_suffix_on_decompression: true # (default. sets for decompression node to remove the algorithm-suffix, and does not introduce a new suffix, this is anyway the default so nothing has to be done in the plugin.yaml. The Alterative would be to to keep the algorithm suffix (so dont remove it) and to add a decompression suffix ("/deco")), but this is not implemented yet. So If this is false then raise an error that this is not yet implemented

  qos:
    defaults:
      depth: 1
    for_role:
      ota_sub:
        reliability: best_effort
      ota_pub:
        reliability: best_effort


peer_settings:
  vehicle:
    heartbeat_topic: "/vehiclebeat"      # should automatically deduce for vehicle: heartbeat_out_topics: /vehiclebeat and for center: heartbeat_in_topic: /shuttle_ella/vehiclebeat

    inbound:
      keep_source_prefix: false                   # on vehicle the center topics should not be prefixed by "center"
      keep_target_prefix: false                   # vehicle should remove the target e.g. the prefix /to_shuttle_ella (this setting always false currenty. if true then raise an error that unimplemented. )

    outbound:
      source_prefix:
        native_have_source_prefix: false          # vehicle does natively not use their own source prefix, e.g. /shuttle_ella (nothing to set here, since it is false, but if true this should be setting the app_has_source_name_outbound to the local name of the peer)
        use_source_prefix: true                   # always prefix source where a ota topic come from, e.g. /cetner or vehiclename (this is currently always true and does not need to be set here in the plugin.yaml). If set to false than raise an error that is not implemented yet.)
      target_prefix:
        native_have_outgoing_target_prefix: false # vehicles do natively not use targets such as /to_center
        use_target_prefix: false                  # dont use to_center prefix (since its false there is no need need to set anything here in the plugin.yaml)

    framebridge:                         # this existing of this setting defines that a framebridge node should be created on vehicle (fb:true). the topics are not defined here, but in the topics below. with this the argements for the node should be deduced from the topics below automatically.
      global_frame_prefix: "${vehicle_name}_"
      exclude_frames: ["map", "cart"]    # all frames are local and should be prefixed, except for map and cart, these are global already and do not need to be prefixed

  center:
    heartbeat_topic: "/centerbeat"

    inbound:
      keep_source_prefix: true            # center wants /${vehicle_name}/... for inbound. Set via local_explicitly_targeted_inbound true
      # keep_target prefix:               # no effect in this config (for now). would only matter if the other peer would use a target prefix which is not the case. does not matter as their is no targetet topics to center yet

    outbound:
      source_prefix:
        native_have_source_prefix: false         # control center does prefix local topics with /center (nothing to set here, since it is false, but if true this should be setting the app_has_source_name_outbound to the local name of the peer)
        use_source_prefix: true                  # always prefix source where a ota topic come from, e.g. /cetner or vehiclename (this is currently always true and does not need to be set here in the plugin.yaml). If set to false than raise an error that is not implemented yet.)
      target_prefix:
        native_have_outgoing_target_prefix: true # center uses targets such as /to_shuttle_ella or /to_shuttle_anna. this is set via specifying the remote name as the target name on outbound bridge+relay via remote_explicitly_targeted_name_outbound: shuttle_ella
        use_target_prefix: true                  # add prefix /to_$vehiclename to outgoing topics. this is set via specifying the remote name as the target name on outbound bridge+relay via remote_explicitly_targeted_name_outbound: shuttle_ella. Also sets for the other peer (vehicle) to have local_explicitly_targeted_inbound true.

    # Info for: "native_have_outgoing_target_prefix" & "outbound topics use_target_prefix":
        # 1. currently the we modell in this config two options:
        #   - native-topics have outgoing target prefixes
        #   - outbound-topics use those target prefix (which are already existant specified natively)
        # But these two options are not fully implemented yet. Currently they can only be set both to true or both to false due to the limited way the plugin.yaml is designed: So either 
        #   - the native topics have no outgoing topics and and also do not use target prefix for outgoint messages
        #   - or the app topics have already an target prefix which will be used for outgoing topics
        # this is set implicitly by specifiying a target names in the outbound bidges/relays via remote_explicitly_targeted_name_outbound
        # so the following is not configured:
        #   - if there is app topic without target prefix which should when beeing send be addressed to a specific target with a target prefix
        #       - application-topics have outgoing target prefixes: false 
        #       - outbound-topics use target prefix: true
        #   - that there is a app topic with a target prefix which sould be send without the target prefix
        # so it any unconfigured opption is chosen through an error 
        # 2. furthermore if naive topics have outgoing target prefixes is true for one peer, then for the other peer it should be automatically set for the other peer to have local_explicitly_targeted_inbound true.

topics:

# via the direction specific topics there can be the two file transmit_topics_to_center and tranmist_topics_to_vehicle erstellt werden

  center_to_vehicle:
    - "/centerbeat"
    - topic: "/move_base_free/goal"
      processing:
        framebridge: "global_to_local"   # it already has the global prefix and this should be reversed by the bridge. so it has to added to the global_to_local in the framebridge that is located on the vehicle
    - "/planning/free/reset"

  vehicle_to_center:
    - "/vehiclebeat"

    - topic: "/tf"
      processing:
        restamp_if: ${vehicle_bag_playback}
        framebridge: "local_to_global"
        normalize_on_target: true # note regarding normalization: normalization means the removal of source (and/or target, but i dont have this use-case yet) and processing suffix from the topic so that it is renamed to the base_topic. This should be done on target, meaning, that on the control center the prefix /shuttle_ella, and the suffix /restamped/globalframe should be removed. For this use the "nor" funcitonality. Automatically deduced should be nor_X_topic_prefix, _base, _suffix

    - topic: "/tf_static"
      processing:
        restamp_if: ${vehicle_bag_playback}
        framebridge: "local_to_global"
        normalize_on_target: true # general note regarding: normalization, trottle, pixel cap, transport und reverse transport, each can only have 4 instances as defined in base_session. if there are more a error should be issued
      qos: # all topic qos should be merged with the default qos above for the creation of the full qos-file
        reliability: reliable
        durability: transient_local
        depth: 100

    - topic: "/costmap/costmap"
      processing:
        restamp_if: ${vehicle_bag_playback}
        framebridge: "local_to_global"
        compress: true            # it should be automatically determined on which peer a compressor / decompression is required and deduce the respective parameters.

    - topic: "/visualization/planning/pso/submitted_visualization"
      processing:
        restamp_if: ${vehicle_bag_playback}
        framebridge: "local_to_global"
        compress: true

    - topic: "/visualization/planning/free/curvature_planning"
      processing:
        restamp_if: ${vehicle_bag_playback}
        framebridge: "local_to_global"
        compress: true

    - topic: "/visualization/planning/free/result"
      processing:
        restamp_if: "vehicle_bag_playback"
        framebridge: "local_to_global"
        compress: true

    - topic: "/visualization/planning/free/curvature_optimizing"
      processing:
        restamp_if: ${vehicle_bag_playback}
        framebridge: "local_to_global"
        compress: true

    - topic: "/visualization/maneuver/announcements_barriers"
      processing:
        restamp_if: "vehicle_bag_playback"
        framebridge: "local_to_global"
        compress: true

    - topic: "/visualization/map/sliding_driving_area"
      processing:
        restamp_if: ${vehicle_bag_playback}
        framebridge: "local_to_global"
        compress: true

    # Cameras (pipeline: restamp -> throttle -> pixel_cap -> image_transport)
    - topic: "/sensors/camera/front_wide/image_color"
      processing:
        restamp_if: ${vehicle_bag_playback}
        throttle_hz: 25
        pixel_cap_preset: "wxga"
        transport:
          type: "ffmpeg"
          gop_size: 10
          bit_rate: 10000000
          encoder_av_options: "tune:zerolatency"
          local_republish: true # to see locally (the vehicle) what could be reconstructed remotly. uses reverse tranport (irt). should lead to irt=true, and decuce irt_x_transport=ffmpeg automatically. Important: the irt on the remote should be done automatically always if there are ffmpeg topics and do not need any config. Only the local reconstruction should be have to be specified if wanted.

    - topic: "/sensors/camera/front_wide/image_color2"
      processing:
        restamp_if: ${vehicle_bag_playback}
        throttle_hz: 25
        pixel_cap_preset: "wxga"
        transport:
          type: "ffmpeg"
          gop_size: 10
          encoder_av_options: "tune:zerolatency,crf:28"
          local_republish: true # to see locally (the vehicle) what could be reconstructed remotly. uses reverse tranport (irt). should lead to irt=true, and decuce irt_x_transport=ffmpeg automatically. Important: the irt on the remote should be done automatically always if there are ffmpeg topics and do not need any config. Only the local reconstruction should be have to be specified if wanted.

    - topic: "/sensors/camera/front_wide/image_color3"
      processing:
        restamp_if: ${vehicle_bag_playback}
        throttle_hz: 20
        pixel_cap_preset: "wsvga"
        transport:
          type: "compressed"
          jpeg_quality: 14

    - "/waypoint_ack"
    - "/gui/softstop"
    - "/execution/debug/switchbox_state_extra"
    - "/gnss_reference"
    - "/odometry/can"
    - "/can/twist"
    - "/can/is_autonomous"
    - "/can/is_rearmed"
    - "/can/steering_angle"
    - "/can/safety_plc_estop_causes"
    - "/mission/debug/drive_to_state"
    - "/mission/progress"
    - "/mission/current_goal"
    - "/mission/mission_sender/active"
    - "/site"
    - "/type"
    - "/user/id"
    - "/vehicle"
    - "/version"
    - "/planning/free/active"
    - "/perception/dynamic_obstacles"
    - "/hmi/switches"
    # - "/planning/free/a_star_curvature_planner_nodelet/out_costmap"
    # - "/traffic_monitor/download_rate_kbps"
    # - "/traffic_monitor/upload_rate_kbps"
    # - "/wifi_ap"
    # - "/wifi_sl"
    # - "/wifi_ssid"